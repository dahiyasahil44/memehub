<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemeHub - An meme watch Platform</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
  
    <style>
        #meme-battle{padding: 1rem 0;}

        .batle-wrap{border: 1px solid #bbb;margin-bottom: 2rem;}
        .battle-card{display: flex;gap: 1rem;justify-content: space-between;padding: 1rem;}
        .battle-card>div{width: 49%;}
        .battle-card .meme-card{margin-bottom: 0;}
        .battle-card .meme-media img{height: 200px;}
        .battle-card .meme-media h3{margin-bottom: 1rem;}
        .battle-timer{display: flex;justify-content: space-between;background-color: var(--primary);padding: 1rem;}
        .battle-timer>h2{text-align: center;font-size: 1.2rem;
        color: #fff;}
    </style>
</head>

<body>
    <div id="header"></div>


    <main class="main-layout">

        <div id="left-sidebar"></div>

        <div id="main-content">

            <div class="meme-head mb-1">
                <h3>Meme Battle</h3>
            </div>

            <div id="meme-battle">
                <!-- <div class="batle-wrap">
                    <div class="battle-timer">
                        <h2>Time remaining:</h2>
                        <h2>32:42:98</h2>
                    </div>
                    <div class="battle-card">
                        <div class="battle-meme1">
                            <div class="meme-card">
                                <div class="meme-head">
                                    <div class="m-head-left">
                                        <span><img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464301/qkzdcvqqfrz4v3bndmba.jpg" alt="user avatar"></span>
                                        <span>dankmemer</span>
                                        <span>17h ago</span>
                                    </div>
                                    <div class="m-head-right"><span><i class="fa-solid fa-flag"></i></span></div>
                                </div>
                                <div class="meme-media">
                                    <h3 class="mb-1">Life lately</h3>
                                    <img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464365/fj3jjdc3y8703i1cupwj.jpg" alt="Life lately" loading="lazy">
                                </div>
                                <div class="meme-tags">
                                    <span>#memes</span><span>#code</span><span>#pain</span><span>#fun</span><span>#mix</span><span>#coding</span>
                                </div>
                                <div class="meme-actions">
                                    <button class="primary-btn btn-sm">Vote A</button>
                                </div>
                            </div>
                        </div>
                        <div class="battle-meme2">
                            <div class="meme-card">
                                <div class="meme-head">
                                    <div class="m-head-left">
                                        <span><img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464301/qkzdcvqqfrz4v3bndmba.jpg" alt="user avatar"></span>
                                        <span>dankmemer</span>
                                        <span>17h ago</span>
                                    </div>
                                    <div class="m-head-right"><span><i class="fa-solid fa-flag"></i></span></div>
                                </div>
                                <div class="meme-media">
                                    <h3 class="mb-1">Life lately</h3>
                                    <img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464365/fj3jjdc3y8703i1cupwj.jpg" alt="Life lately" loading="lazy">
                                </div>
                                <div class="meme-tags">
                                    <span>#memes</span><span>#code</span><span>#pain</span><span>#fun</span><span>#mix</span><span>#coding</span>
                                </div>
                                <div class="meme-actions">
                                    <button class="primary-btn btn-sm">Vote B</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="batle-wrap">
                    <div class="battle-timer">
                        <h2>Time remaining:</h2>
                        <h2>32:42:98</h2>
                    </div>
                    <div class="battle-card">
                        <div class="battle-meme1">
                            <div class="meme-card">
                                <div class="meme-head">
                                    <div class="m-head-left">
                                        <span><img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464301/qkzdcvqqfrz4v3bndmba.jpg" alt="user avatar"></span>
                                        <span>dankmemer</span>
                                        <span>17h ago</span>
                                    </div>
                                    <div class="m-head-right"><span><i class="fa-solid fa-flag"></i></span></div>
                                </div>
                                <div class="meme-media">
                                    <h3 class="mb-1">Life lately</h3>
                                    <img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464365/fj3jjdc3y8703i1cupwj.jpg" alt="Life lately" loading="lazy">
                                </div>
                                <div class="meme-tags">
                                    <span>#memes</span><span>#code</span><span>#pain</span><span>#fun</span><span>#mix</span><span>#coding</span>
                                </div>
                                <div class="meme-actions">
                                    <button class="primary-btn btn-sm">Vote A</button>
                                </div>
                            </div>
                        </div>
                        <div class="battle-meme2">
                            <div class="meme-card">
                                <div class="meme-head">
                                    <div class="m-head-left">
                                        <span><img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464301/qkzdcvqqfrz4v3bndmba.jpg" alt="user avatar"></span>
                                        <span>dankmemer</span>
                                        <span>17h ago</span>
                                    </div>
                                    <div class="m-head-right"><span><i class="fa-solid fa-flag"></i></span></div>
                                </div>
                                <div class="meme-media">
                                    <h3 class="mb-1">Life lately</h3>
                                    <img src="https://res.cloudinary.com/dehamh3j6/image/upload/v1747464365/fj3jjdc3y8703i1cupwj.jpg" alt="Life lately" loading="lazy">
                                </div>
                                <div class="meme-tags">
                                    <span>#memes</span><span>#code</span><span>#pain</span><span>#fun</span><span>#mix</span><span>#coding</span>
                                </div>
                                <div class="meme-actions">
                                    <button class="primary-btn btn-sm">Vote B</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
            </div>

        </div>

        <div id="right-sidebar"></div>

    </main>


    <script type="module" src="./js/main.js"></script>

    <script type="module">
        import {
          auth,
          db,
          signInWithEmailAndPassword,
          onAuthStateChanged,
          doc,
          getDoc
        } from "/js/firebase-init.js";
      
        const url = 'https://memehub-4e730-default-rtdb.asia-southeast1.firebasedatabase.app/';
        let allBattles = [];
        let allBattlesFiltered = [];
      
        onAuthStateChanged(auth, (user) => {
          // Optional login redirect logic
          // if (!user) window.location = "/login.html";
        });
      
        async function fetchData() {
          try {
            const res = await fetch(`${url}/battles.json`);
            const data = await res.json();
            allBattles = Object.entries(data || {}).map(([id, val]) => ({ id, ...val }));
            allBattles.sort(() => Math.random() - 0.5);
      
            // Optional filtering by currentUser
            // if (currentUser?.uid) {
            //   allBattles = allBattles.filter(battle => battle.UID === currentUser.uid);
            // }
      
            allBattlesFiltered = [...allBattles];
            renderAllBattles(allBattlesFiltered);
          } catch (err) {
            console.error("Error fetching battles:", err);
          }
        }
      
        function renderAllBattles(battles) {
          const container = document.getElementById("meme-battle");
          container.innerHTML = ""; // Clear previous battles
          battles.forEach(battle => {
            container.appendChild(renderBattle(battle));
          });
        }
      
        function renderBattle(battle) {
          const wrapper = document.createElement("div");
          wrapper.className = "batle-wrap";
      
          const timeLeft = calculateRemainingTime(battle.endTime);
      
          wrapper.innerHTML = `
            <div class="battle-timer">
                <h2>Time remaining:</h2>
                <h2 class="countdown" data-end="${battle.endTime}" data-battle-id="${battle.id}">
                  ${timeLeft}
                </h2>
            </div>
            <div class="battle-card">
                ${battle.memes.map((meme, index) => `
                  <div class="battle-meme${index + 1}">
                    <div class="meme-card">
                        <div class="meme-media">
                            <h3>${meme.title}</h3>
                            <img src="${meme.image}" alt="${meme.title}" loading="lazy">
                        </div>
                        <div class="meme-tags">
                            ${meme.tags.map(tag => `<span>#${tag}</span>`).join('')}
                        </div>
                        <div class="meme-actions">
                            <button class="primary-btn btn-sm vote-btn"
                                data-battle-id="${battle.id}"
                                data-meme-id="${meme.id}">
                                Vote ${index === 0 ? "A" : "B"}
                            </button>
                        </div>
                    </div>
                  </div>
                `).join('')}
            </div>
          `;
      
          return wrapper;
        }
      
        document.addEventListener("click", async (e) => {
          if (e.target.classList.contains("vote-btn")) {
            const battleId = e.target.dataset.battleId;
            const memeId = e.target.dataset.memeId;
      
            if (!currentUser?.uid) {
              alert("You need to be logged in to vote.");
              return;
            }
      
            try {
              const res = await fetch(`${url}/battles/${battleId}.json`);
              const battle = await res.json();
      
              const alreadyVoted = (battle.upvotedBy || []).some(v => v.UID === currentUser.uid);
              if (alreadyVoted) {
                alert("You have already voted in this battle.");
                return;
              }
      
              const updatedVotes = [...(battle.upvotedBy || []), {
                UID: currentUser.uid,
                memeID: memeId
              }];
      
              await fetch(`${url}/battles/${battleId}/upvotedBy.json`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedVotes)
              });
      
              alert("Vote submitted!");
            } catch (error) {
              console.error("Voting error:", error);
              alert("Something went wrong. Try again.");
            }
          }
        });
      
        function calculateRemainingTime(endTimestamp) {
          const now = Date.now();
          const distance = endTimestamp - now;
          if (distance <= 0) return "00:00:00";
      
          const hours = String(Math.floor(distance / (1000 * 60 * 60))).padStart(2, '0');
          const minutes = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
          const seconds = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, '0');
      
          return `${hours}:${minutes}:${seconds}`;
        }
      
        function startCountdown() {
          setInterval(() => {
            document.querySelectorAll(".countdown").forEach(el => {
              const endTime = parseInt(el.dataset.end);
              el.textContent = calculateRemainingTime(endTime);
            });
          }, 1000);
        }
      
        fetchData();
        startCountdown();
      </script>
      
</body>

</html>